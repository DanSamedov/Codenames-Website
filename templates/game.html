{% extends 'base.html' %} {% load static %} {% block content %}
<h1>Game {{ game_obj.id }} Started</h1>
<p>Your nickname: {{ current_player.username }}</p>
<p>Your team: {{ current_player.team }}</p>

<ul id="cards">
  {% for card in cards %} {% for word in card.words %}
  <li
    id="card-{{ word.word }}"
    data-color="{{ word.color }}"
    data-is-chosen="false"
    onclick="card_choice(this.id)"
  >
    {{ word.word }}
  </li>
  {% endfor %} {% endfor %}
</ul>

{% endblock %}
<!-- prettier-ignore -->
{% block script %}
<script>
  var game_id = '{{ game_obj.id }}';

  var gameSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/game/' + game_id + '/',
  );

  gameSocket.onclose = function (e) {
    console.error('Room was closed unexpectedly');
  };

  gameSocket.onmessage = function (e) {
    var data = JSON.parse(e.data);

    if (data.action === 'player_join') {
      var username = data['username'];
      var leader_list = data['leader_list'];

      if (leader_list.includes(username)) {
        var cards = document.querySelectorAll("[id^='card-']");
        console.log(cards);
        cards.forEach(card => {
          card.style.backgroundColor = card.dataset.color;
        });
      }
    } else if (data.action === 'choose_card') {
      let username = data['username'];
      let card_id = data['card_id'];
      let card_status = data['card_status'];

      let card = document.getElementById(card_id);

      if (card_status === true) {
        card.style.border = '2px solid yellow';
        card.dataset.isChosen = 'true';
      } else {
        card.style.border = '';
        card.dataset.isChosen = 'false';
      }
    }
  };

  function card_choice(card_id) {
    let card = document.getElementById(card_id);
    let isChosen = card.dataset.isChosen;

    if (isChosen === 'true') {
      card.style.border = '';
      card.dataset.isChosen = 'false';
    } else {
      card.style.border = '2px solid yellow';
      card.dataset.isChosen = 'true';
    }

    gameSocket.send(
      JSON.stringify({
        action: 'card_choice',
        card_id: card_id,
        card_status: card.dataset.isChosen === 'true',
      }),
    );
    console.log(card.dataset.isChosen);
  }
</script>
{% endblock %}
